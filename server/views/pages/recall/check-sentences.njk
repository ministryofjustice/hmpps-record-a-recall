{% extends "prisonerBannerBackLayout.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "hmpps/components/court-cases-release-dates/offence-card/macro.njk" import offenceCard %}

{% set title = "Check that the sentences and offences are correct" %}
{% set pageTitle = applicationName + " - " + title %}

{% block beforeContent %}
    {{ super() }}
    <div class="govuk-width-container">
        <div class="govuk-grid-row govuk-!-margin-bottom-0">
            <div class="govuk-grid-column-two-thirds">
                {# Error summary is handled in prisonerBannerBackLayout #}
            </div>
            <div class="govuk-grid-column-one-quarter govuk-!-text-align-right">
                <a href="/person/{{ nomisId }}/sentences" class="govuk-link">View raw sentence data</a>
            </div>
        </div>
    </div>
{% endblock %}

{% block pageContent %}
    <h1 class="govuk-heading-xl">
        <span class="govuk-caption-xl">{{ pageCaption }}</span>
        {{ title }}
    </h1>

    <p>
        {% if latestSled %}
            The latest SLED (Sentence and licence expiry date) is <b>{{ latestSled | sentenceDate }}</b>. This is the SLED on this person's licence.
        {% else %}
            The SLED (Sentence and licence expiry date) is not available.
        {% endif %}
    </p>

    <h2 class="govuk-heading-l">
        Court cases with sentences eligible for recall ({{ summarisedSentencesGroups.length }})
    </h2>

    {{ sentenceCards(summarisedSentencesGroups, offenceNameMap) }}

    <h2 class="govuk-heading-l govuk-!-margin-top-8">Confirm the sentences and offences are correct</h2>

    <p class="govuk-body">If you think some information is wrong, you can manage all court case
        information <a class="govuk-link" target="external" href="{{ urls.ccards }}">Court cases and
        release dates (opens in a new tab)</a>.
    </p>

    <form method="post" action="">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}">

        <div class="govuk-button-group">
            {{ govukButton({
                text: "Confirm and continue",
                preventDoubleClick: true,
                type: "submit",
                attributes: {
                    "data-qa": "confirm-and-continue-btn",
                    id: "submit"
                }
            }) }}

            {{ govukButton({
                text: "Cancel",
                classes: "govuk-button--secondary",
                preventDoubleClick: true,
                href: cancelUrl
            }) }}
        </div>
    </form>
{% endblock %}

{% macro sentenceCards(groups, offenceNameMap) %}
    {% for group in groups %}
        <h3 class="govuk-heading-m">{{ group.caseRefAndCourt }}</h3>

        {% for sentence in group.eligibleSentences %}
            {{ sentenceCard(sentence, offenceNameMap) }}
        {% endfor %}

        {% if group.hasIneligibleSentences %}
            {% set ineligibleHtml %}
                {% for sentence in group.ineligibleSentences %}
                    {{ sentenceCard(sentence, offenceNameMap) }}
                {% endfor %}
            {% endset %}

            {% set summaryHtml %}
                View sentences that are ineligible for recall ({{ group.ineligibleSentences | length }})
            {% endset %}

            {{ govukDetails({
                summaryHtml: summaryHtml,
                html: ineligibleHtml
            }) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

{% macro sentenceCard(sentence, offenceNameMap) %}
    {% set offenceStartDate = sentence.offenceStartDate | formatDate if sentence.offenceStartDate else 'Not entered' %}
    {% set offenceEndDate = sentence.offenceEndDate | formatDate if sentence.offenceEndDate else null %}
    {% set sentenceDate = sentence.sentenceDate | formatDate if sentence.sentenceDate else 'Not available' %}

    {# Determine numeric values for count and line number #}
    {% if sentence.countNumber and sentence.countNumber != '-1' %}
        {% set countNumberWithText = sentence.countNumber %}
        {% set lineNumberWithText = null %}
    {% elseif not sentence.countNumber %}
        {% set countNumberWithText = null %}
        {% set lineNumberWithText = sentence.lineNumber %}
    {% else %}
        {# countNumber is '-1' â†’ show neither #}
        {% set countNumberWithText = null %}
        {% set lineNumberWithText = null %}
    {% endif %}

    {# Add eligibility information if the sentence is ineligible #}
    {% set cardHtml %}
        {{ offenceCard({
            countNumber: countNumberWithText,
            offenceCode: sentence.offenceCode | default('N/A'),
            offenceName: sentence.offenceDescription or offenceNameMap[sentence.offenceCode] or 'Offence description not available',
            offenceStartDate: offenceStartDate,
            offenceEndDate: offenceEndDate,
            hideOutcome: true,
            outcome: sentence.outcome | default('N/A'),
            lineNumber: lineNumberWithText,
            periodLengths: sentence.periodLengths | periodLengthsToSentenceLengths | default('N/A'),
            sentenceServeType: sentence.sentenceServeType | default(null),
            sentenceType: sentence.sentenceType | default('N/A'),
            sentenceDate: sentenceDate,
            fineAmount: sentence.fineAmount | string | default(null) if sentence.fineAmount else null,
            isSentenced: true,
            detailsClasses: 'govuk-!-padding-4'
        }) }}
    {% endset %}

    {{ cardHtml | safe }}
{% endmacro %}
