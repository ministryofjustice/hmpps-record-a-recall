{% extends "../../partials/prisonerBannerLayout.njk" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/character-count/macro.njk" import govukCharacterCount %}
{% from "govuk/components/date-input/macro.njk" import govukDateInput %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "hmpps/components/court-cases-release-dates/offence-card/macro.njk" import offenceCard %}

{% set errors = validationErrors[0].text %}

{% block beforeContent %}
    {{ super() }}
    <div class="govuk-width-container">
        <div class="govuk-grid-row govuk-!-margin-bottom-0">
            <div class="govuk-grid-column-two-thirds">
              <nav>
              {{ govukBackLink({
                    text: "Back",
                    href: backLink
                }) }}
              </nav>
                {% if errorlist.length %}
                    {{ govukErrorSummary({
                        titleText: "There is a problem",
                        errorList: validationErrors,
                        classes: "govuk-!-margin-top-7 govuk-!-margin-bottom-0"
                    }) }}
                {% endif %}
            </div>
            <div class="govuk-grid-column-one-quarter govuk-!-text-align-right">
                <a href="/person/{{ nomisId }}/sentences" class="govuk-link">View raw sentence data</a>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    {% set formMethod = options.method | default('post') %}
    {% set formAction = options.action | default('') %}
    {% set formEnctype = options.enctype | default('') %}
    <div class="govuk-width-container">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">

                <form method="{{ formMethod }}" action="{{ formAction }}"
                        {% if formEnctype %}
                            enctype="{{ formEnctype }}"
                        {% endif %}
                >

                    {% if formMethod == 'post' %}
                        <input type="hidden" name="_csrf" value="{{ csrfToken }}">
                    {% endif %}

                    {% block sentenceInfo %}

                            <h1 class="govuk-heading-xl">
                                <span class="govuk-caption-xl">Record a recall</span>
                                Check that the sentences and offences are correct
                            </h1>
                          <p>
                              {% if latestSled %}
                                The latest SLED (Sentence and licence expiry date) is <b>{{ latestSled | sentenceDate }}</b>. This is the SLED on this person's licence.
                              {% else %}
                                The SLED (Sentence and licence expiry date) is not available.
                              {% endif %}
                          </p>
                          
                          {% if summarisedSentencesGroups.length > 0 %}
                              <h2 class="govuk-heading-l">
                                  Court cases with sentences eligible for recall ({{ summarisedSentencesGroups.length }})
                              </h2>
                              {{ sentenceCards(summarisedSentencesGroups, offenceNameMap) }}
                          {% else %}
                              <h2 class="govuk-heading-l">
                                  No sentences are eligible for recall
                              </h2>
                              <div class="govuk-warning-text">
                                  <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                                  <strong class="govuk-warning-text__text">
                                      <span class="govuk-warning-text__assistive">Warning</span>
                                      Based on the revocation date provided, there are no sentences eligible for recall. This may be because:
                                  </strong>
                              </div>
                              <ul class="govuk-list govuk-list--bullet">
                                  <li>The revocation date is after the sentence and licence expiry date (SLED)</li>
                                  <li>The revocation date is before the conditional release date (CRD)</li>
                                  <li>There are no valid sentences available for this person</li>
                              </ul>
                              <p class="govuk-body">
                                  Please review the revocation date and try again, or contact support if you believe this is an error.
                              </p>
                          {% endif %}

                    {% endblock %}

                  {% if summarisedSentencesGroups.length > 0 %}
                      <h2 class="govuk-heading-l govuk-!-margin-top-8">Confirm the sentences and offences are correct</h2>

                      <!-- Call to action -->
                      <p class="govuk-body">If you think some information is wrong, you can manage all court case
                        information <a class="govuk-link" target="external" href="{{ urls.ccards }}">Court cases and
                          release dates (opens in a new tab)</a>.</p>
                  {% endif %}

                    <div class="govuk-button-group">
                        {% block formActions %}
                          {% if summarisedSentencesGroups.length > 0 %}
                              {% block submitAction %}
                                  {{ govukButton({
                                      text: "Confirm and continue",
                                      classes: options.buttonClasses,
                                      preventDoubleClick: true,
                                      type: "submit",
                                      attributes: {
                                        "data-qa": "confirm-and-continue-btn"
                                    }
                                  }) }}
                              {% endblock %}
                          {% endif %}

                          {% block cancel %}
                            {{ govukButton({
                                text: "Cancel",
                                classes: "govuk-button--secondary",
                                preventDoubleClick: true,
                                type: "reset",
                                href: cancelLink
                              }) }}
                          {% endblock %}
                      {% endblock %}
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{%  macro sentenceCards(groups, offenceNameMap) %}
    {% for group in groups %}
        <h3 class="govuk-heading-m">{{ group.caseRefAndCourt }} </h3>

        {% for sentence in group.eligibleSentences %}
            {{ sentenceCard(sentence, offenceNameMap) }}
        {% endfor %}
        {% from "govuk/components/details/macro.njk" import govukDetails %}
        {% if group.hasIneligibleSentences %}
            {% set ineligibleHtml %}
                {% for sentence in group.ineligibleSentences %}
                    {{ sentenceCard(sentence, offenceNameMap) }}
                {% endfor %}
            {% endset %}
            {% set summaryHtml %}
                View sentences that are ineligible for recall ({{ group.ineligibleSentences | length }})
            {%  endset %}
        {{ govukDetails({
            summaryHtml: summaryHtml,
            html: ineligibleHtml
        }) }}
        {% endif %}
    {% endfor %}

{% endmacro %}

{% macro sentenceCard(sentence, offenceNameMap) %}
    {% set offenceStartDate = sentence.offenceStartDate | formatDate if sentence.offenceStartDate else 'Not entered' %}
    {% set offenceEndDate = sentence.offenceEndDate | formatDate if sentence.offenceEndDate else null %}
    {% set sentenceDate = sentence.sentenceDate | formatDate if sentence.sentenceDate else 'Not available' %}
    {# Determine numeric values for count and line number #}
    {% if sentence.countNumber and sentence.countNumber != '-1' %}
        {% set countNumberWithText = sentence.countNumber %}
        {% set lineNumberWithText = null %}
    {% elseif not sentence.countNumber %}
        {% set countNumberWithText = null %}
        {% set lineNumberWithText = sentence.lineNumber %}
    {% else %}
        {# countNumber is '-1' â†’ show neither #}
        {% set countNumberWithText = null %}
        {% set lineNumberWithText = null %}
    {% endif %}

    {{ offenceCard({
      countNumber: countNumberWithText,
      offenceCode: sentence.offenceCode | default('N/A'),
      offenceName: sentence.offenceDescription or offenceNameMap[sentence.offenceCode] or 'Offence description not available',
      offenceStartDate: offenceStartDate,
      offenceEndDate: offenceEndDate,
      hideOutcome: true,
      outcome: sentence.outcome | default('N/A'),
      lineNumber: lineNumberWithText,
      periodLengths: sentence.periodLengths | periodLengthsToSentenceLengths | default('N/A'),
      sentenceServeType: sentence.sentenceServeType | default(null),
      sentenceType: sentence.sentenceType | default('N/A'),
      sentenceDate: sentenceDate,
      fineAmount: sentence.fineAmount | string | default(null) if sentence.fineAmount else null,
      isSentenced: true,
      detailsClasses: 'govuk-!-padding-4'
    }) }}
{% endmacro %}


