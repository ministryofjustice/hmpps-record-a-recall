{% extends "../../partials/prisonerBannerLayout.njk" %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "hmpps/components/court-cases-release-dates/offence-card/macro.njk" import offenceCard %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

{% set pageTitle = "Select all cases that had an active sentence" %}
{% set pageId = "select-court-case-details" %}

{% block pageTitle %}
  {{ pageTitle }} - {{ serviceName }}
{% endblock %}

{% block beforeContent %}
  {{ super() }} {# This renders the prisoner banner from prisonerBannerLayout.njk #}
  {{ govukBackLink({
    text: "Back",
    href: backLinkUrl
  }) }}
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {% if errors.list | length %}
        {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: errors.list
        }) }}
      {% endif %}

      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">Record a recall</span>
        {{ pageTitle }}
      </h1>
      <p class="govuk-body">The sentence must have been active when the person's licence was revoked. Any missing sentence types can be added later.</p>
      <p class="govuk-body-m govuk-!-font-weight-bold govuk-!-margin-bottom-5">Court case {{ currentCaseIndex + 1 }} of {{ totalCases }}</p>

          {# Recallable Offences Section #}
          {% if currentCase.recallableSentences and currentCase.recallableSentences.length > 0 %}
            <h2 class="govuk-heading-m govuk-!-font-weight-bold govuk-!-margin-top-3 govuk-!-margin-bottom-3">
            {% if currentCase.courtCode %}{{ currentCase.courtCode }} at {% endif %}
              {{ currentCase.courtName | default("N/A") }} on {{ currentCase.formattedOverallConvictionDate | default("N/A") }}
            </h2>

      {% for sentence in currentCase.recallableSentences %}
            {% if sentence.sentenceTypeDescription == 'Required' %}
              {% set sentenceTypeDisplay = '<strong class="govuk-tag govuk-tag--blue">Required</strong>' %}
            {% else %}
              {% set sentenceTypeDisplay = sentence.sentenceTypeDescription | default("N/A") %}
            {% endif %}

            {% set sentenceDate = sentence.sentenceDate | formatDate if sentence.sentenceDate else 'N/A' %}

            {{ offenceCard({
                offenceCode: sentence.offenceCode | default("N/A"),
                offenceName: sentence.apiOffenceDescription | default(sentence.offenceDescription) | default("N/A"),
                offenceStartDate: sentence.offenceStartDate | default('N/A'),
                offenceEndDate: sentence.offenceEndDate | default(null),
                outcome: sentence.formattedOutcome | default("N/A"),
                countNumber: loop.index,
                convictionDate: sentence.formattedConvictionDate | default("N/A"),
                terrorRelated: sentence.terrorRelated | default(false),
                isSentenced: true,
                periodLengths: sentence.periodLengths | default([]),
                sentenceServeType: sentence.sentenceServeType | default(null),
                consecutiveTo: sentence.consecutiveToChargeNumber | default(null),
                sentenceType: sentenceTypeDisplay | safe,
                sentenceDate: sentenceDate,
                fineAmount: sentence.fineAmount | string | default(null) if sentence.fineAmount else null,
                detailsClasses: 'govuk-!-padding-4',
                actions: null,
                listItems: null
            }) }}
          {% endfor %}
        {% endif %}

          {# Non-Recallable Sentences Dropdown #}
          {% if currentCase.hasNonRecallableSentences %}
            <details class="govuk-details govuk-!-margin-top-4" data-module="govuk-details">
              <summary class="govuk-details__summary">
                <span class="govuk-details__summary-text">
                  View offences which are not eligible for recall ({{ currentCase.nonRecallableSentences.length }})
                </span>
              </summary>
              <div class="govuk-details__text">
                {% for sentence in currentCase.nonRecallableSentences %}
                {% set sentenceDate = sentence.sentenceDate | formatDate if sentence.sentenceDate else 'N/A' %}
                  {{ offenceCard({
                      offenceCode: sentence.offenceCode | default("N/A"),
                      offenceName: sentence.apiOffenceDescription | default(sentence.offenceDescription) | default("N/A"),
                      offenceStartDate: sentence.offenceStartDate | default('N/A'),
                      offenceEndDate: sentence.offenceEndDate | default(null),
                      outcome: sentence.formattedOutcome | default("N/A"),
                      countNumber: loop.index,
                      convictionDate: sentence.formattedConvictionDate | default("N/A"),
                      terrorRelated: sentence.terrorRelated | default(false),
                      isSentenced: true,
                      periodLengths: sentence.periodLengths | default([]),
                      sentenceServeType: sentence.sentenceServeType | default(null),
                      consecutiveTo: sentence.consecutiveToChargeNumber | default(null),
                      sentenceType: (sentence.sentenceTypeDescription | default("N/A")),
                      sentenceDate: sentenceDate,
                      fineAmount: sentence.fineAmount | string | default(null) if sentence.fineAmount else null,
                      detailsClasses: 'govuk-!-padding-4',
                      actions: null,
                      listItems: null
                  }) }}
                {% endfor %}
              </div>
            </details>
          {% endif %}

      <form method="post" novalidate class="govuk-!-margin-top-6">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>

        {{ govukRadios({
          name: "activeSentenceChoice",
          fieldset: {
            legend: {
              text: "Did this case have an active sentence?",
              isPageHeading: false,
              classes: "govuk-fieldset__legend--m"
            }
          },
          items: [
            {
              value: "YES",
              text: "Yes",
              checked: formResponses.activeSentenceChoice == "YES"
            },
            {
              value: "NO",
              text: "No",
              checked: formResponses.activeSentenceChoice == "NO"
            }
          ],
          errorMessage: errors.activeSentenceChoice
        }) }}

        {{ govukButton({
            text: "Continue",
            preventDoubleClick: true,
            attributes: {
              "data-qa": "continue-btn"
            }
          }) }}
          <a href="{{ cancelLink }}" role="button" draggable="false" class="govuk-button govuk-button--secondary govuk-!-margin-left-1" data-module="govuk-button">
            Cancel
          </a>
      </form>
    </div>
  </div>
{% endblock %}