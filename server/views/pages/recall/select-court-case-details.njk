{% extends "../../partials/layout.njk" %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}

{% set pageTitle = "Select all cases that had an active sentence" %}
{% set pageId = "select-court-case-details" %}

{% block pageTitle %}
  {{ pageTitle }} - {{ serviceName }}
{% endblock %}

{% block beforeContent %}
  {{ govukBackLink({
    text: "Back",
    href: backLinkUrl
  }) }}
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {% if errors.list | length %}
        {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: errors.list
        }) }}
      {% endif %}

      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">Record a recall</span>
        {{ pageTitle }}
      </h1>
      <p class="govuk-body">Relevant cases are those with sentences that were active when this person's licence was revoked.</p>
      <p class="govuk-body-s govuk-!-font-weight-bold govuk-!-margin-bottom-7">Court case {{ currentCaseIndex + 1 }} of {{ totalCases }}</p>

      {# Case Header Block #}
      <div class="app-summary-card govuk-!-margin-bottom-7">
        <h2 class="govuk-heading-m govuk-!-margin-bottom-2">{{ currentCase.caseNumber | default("N/A") }} at {{ currentCase.courtName | default("N/A") }}</h2>
        <dl class="govuk-summary-list">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
              Case references
            </dt>
            <dd class="govuk-summary-list__value govuk-!-font-weight-bold">
              {{ currentCase.caseReferences | default("Not available") }}
            </dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
              Overall sentence length
            </dt>
            <dd class="govuk-summary-list__value govuk-!-font-weight-bold">
              {{ currentCase.formattedOverallSentenceLength | default("Not available") }}
            </dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
              Conviction date
            </dt>
            <dd class="govuk-summary-list__value govuk-!-font-weight-bold">
              {{ currentCase.formattedOverallConvictionDate | default("Not available") }}
            </dd>
          </div>
        </dl>

        {# Offences Section #}
        {% if currentCase.sentences and currentCase.sentences.length > 0 %}
          <h3 class="govuk-heading-m govuk-!-font-weight-bold govuk-!-margin-top-4 govuk-!-margin-bottom-3">Offences ({{ currentCase.sentences.length }})</h3>
          {% for sentence in currentCase.sentences %}
          <div class="app-summary-card app-summary-card--purple-border app-summary-card--shaded govuk-!-margin-bottom-5">
            <p class="govuk-body-s govuk-!-margin-bottom-1">Count {{ loop.index }}</p>
            <h4 class="govuk-heading-m govuk-!-margin-bottom-2">{{ sentence.offenceCode | default("Not available") }} - {{ sentence.offenceDescription | default("Not available") }}</h4>
            <dl class="govuk-summary-list govuk-summary-list--no-border">
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
                  Committed on
                </dt>
                <dd class="govuk-summary-list__value">
                  {{ sentence.formattedOffenceDate | default("Not available") }}
                </dd>
              </div>
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
                  Conviction date
                </dt>
                <dd class="govuk-summary-list__value">
                  {{ sentence.formattedConvictionDate | default("Not available") }}
                </dd>
              </div>
              {% if sentence.sentenceType %}
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
                  Sentence type
                </dt>
                <dd class="govuk-summary-list__value">
                  {{ sentence.sentenceType | default("Not available") }}
                </dd>
              </div>
              {% endif %}
              {% if sentence.formattedSentenceLength and sentence.formattedSentenceLength !== 'Not available' and sentence.formattedSentenceLength !== 'Not specified' %}
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
                  Sentence length
                </dt>
                <dd class="govuk-summary-list__value">
                  {{ sentence.formattedSentenceLength | default("Not available") }}
                </dd>
              </div>
              {% endif %}
              {% if sentence.formattedConsecutiveOrConcurrent and sentence.formattedConsecutiveOrConcurrent !== 'Not available' and sentence.formattedConsecutiveOrConcurrent !== 'Not specified' %}
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
                  Consecutive or concurrent
                </dt>
                <dd class="govuk-summary-list__value">
                  {{ sentence.formattedConsecutiveOrConcurrent | default("Not available") }}
                </dd>
              </div>
              {% endif %}
              {% if sentence.outcome %}
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
                  Outcome
                </dt>
                <dd class="govuk-summary-list__value">
                  {{ sentence.outcome | default("Not available") }}
                </dd>
              </div>
              {% endif %}
              {% if sentence.fineAmount %}
              <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key govuk-!-font-weight-bold">
                  Fine amount
                </dt>
                <dd class="govuk-summary-list__value">
                  {{ "Â£" + (sentence.fineAmount / 100) if sentence.fineAmount else "Not available" }} {# Assumes fineAmount is in pence #}
                </dd>
              </div>
              {% endif %}
            </dl>
          </div>
          {% endfor %}
        {% endif %}

      </div>

      <form method="post" novalidate>
        <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
        
        {{ govukRadios({
          name: "activeSentenceChoice",
          fieldset: {
            legend: {
              text: "Did this case have an active sentence at the point of recall?",
              isPageHeading: false,
              classes: "govuk-fieldset__legend--m"
            }
          },
          items: [
            {
              value: "YES",
              text: "Yes",
              checked: formResponses.activeSentenceChoice == "YES"
            },
            {
              value: "NO",
              text: "No",
              checked: formResponses.activeSentenceChoice == "NO"
            }
          ],
          errorMessage: errors.activeSentenceChoice
        }) }}

        {{ govukButton({
          text: "Continue"
        }) }}
      </form>

    </div>
  </div>
{% endblock %}