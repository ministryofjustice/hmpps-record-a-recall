{% extends "../../partials/layout.njk" %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "moj/components/ticket-panel/macro.njk" import mojTicketPanel %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

{% set pageTitle = "Select all cases that had an active sentence" %}
{% set pageId = "select-court-case-details" %}

{% block pageTitle %}
  {{ pageTitle }} - {{ serviceName }}
{% endblock %}

{% block beforeContent %}
  {{ govukBackLink({
    text: "Back",
    href: backLinkUrl
  }) }}
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {% if errors.list | length %}
        {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: errors.list
        }) }}
      {% endif %}

      <h1 class="govuk-heading-l">
        <span class="govuk-caption-l">Record a recall</span>
        {{ pageTitle }}
      </h1>
      <p class="govuk-body">Relevant cases are those with sentences that were active when this person's licence was revoked.</p>
      <p class="govuk-body-m govuk-!-font-weight-bold govuk-!-margin-bottom-5">Court case {{ currentCaseIndex + 1 }} of {{ totalCases }}</p>

      {# Case Header Block #}
      <div class="govuk-summary-card govuk-!-margin-bottom-7">
        <div class="govuk-summary-card__title-wrapper app-ticket-panel--shaded">
          <h2 class="govuk-summary-card__title">{{ currentCase.caseNumber | default("N/A") }} at {{ currentCase.courtName | default("N/A") }}</h2>
        </div>
        <div class="govuk-summary-card__content">
          {{ govukSummaryList({
              "rows": [
                {
                  "key": { "text": "Case references", "classes": "govuk-!-font-weight-bold" },
                  "value": { "text": currentCase.caseReferences | default("Not available"), "classes": "govuk-!-font-weight-bold" }
                },
                {
                  "key": { "text": "Overall sentence length", "classes": "govuk-!-font-weight-bold" },
                  "value": { "text": currentCase.formattedOverallSentenceLength | default("Not available"), "classes": "govuk-!-font-weight-bold" }
                },
                {
                  "key": { "text": "Conviction date", "classes": "govuk-!-font-weight-bold" },
                  "value": { "text": currentCase.formattedOverallConvictionDate | default("Not available"), "classes": "govuk-!-font-weight-bold" }
                }
              ]
          }) }}

          {# Offences Section #}
          {% if currentCase.sentences and currentCase.sentences.length > 0 %}
            <h3 class="govuk-heading-m govuk-!-font-weight-bold govuk-!-margin-top-7 govuk-!-margin-bottom-3">Offences ({{ currentCase.sentences.length }})</h3>
            {% for sentence in currentCase.sentences %}
              {% set summaryRows = [] %}
              {% set summaryRows = summaryRows.concat([
                { "key": { "text": "Committed on", "classes": "govuk-!-font-weight-bold" }, "value": { "text": sentence.formattedOffenceDate | default("Not available") } },
                { "key": { "text": "Conviction date", "classes": "govuk-!-font-weight-bold" }, "value": { "text": sentence.formattedConvictionDate | default("Not available") } }
              ]) %}
              {% if sentence.sentenceType %}
                {% set summaryRows = summaryRows.concat([{ "key": { "text": "Sentence type", "classes": "govuk-!-font-weight-bold" }, "value": { "text": sentence.sentenceType | default("Not available") } }]) %}
              {% endif %}
              {% if sentence.formattedSentenceLength and sentence.formattedSentenceLength !== 'Not available' and sentence.formattedSentenceLength !== 'Not specified' %}
                {% set summaryRows = summaryRows.concat([{ "key": { "text": "Sentence length", "classes": "govuk-!-font-weight-bold" }, "value": { "text": sentence.formattedSentenceLength | default("Not available") } }]) %}
              {% endif %}
              {% if sentence.formattedConsecutiveOrConcurrent and sentence.formattedConsecutiveOrConcurrent !== 'Not available' and sentence.formattedConsecutiveOrConcurrent !== 'Not specified' %}
                {% set summaryRows = summaryRows.concat([{ "key": { "text": "Consecutive or concurrent", "classes": "govuk-!-font-weight-bold" }, "value": { "text": sentence.formattedConsecutiveOrConcurrent | default("Not available") } }]) %}
              {% endif %}
              {% if sentence.outcome %}
                {% set summaryRows = summaryRows.concat([{ "key": { "text": "Outcome", "classes": "govuk-!-font-weight-bold" }, "value": { "text": sentence.outcome | default("Not available") } }]) %}
              {% endif %}
              {% if sentence.fineAmount %}
                {% set summaryRows = summaryRows.concat([{ "key": { "text": "Fine amount", "classes": "govuk-!-font-weight-bold" }, "value": { "text": "Â£" + (sentence.fineAmount / 100) if sentence.fineAmount else "Not available" } }]) %}
              {% endif %}

            {%- set summaryListHtml -%}
                {{ govukSummaryList({ "rows": summaryRows, "classes": "govuk-summary-list--no-border" }) }}
              {%- endset -%}

              {%- set panelHtml -%}
                <p class="govuk-body-s govuk-!-margin-bottom-1">Count {{ loop.index }}</p>
                <h4 class="govuk-heading-s govuk-!-margin-bottom-2">{{ sentence.offenceCode | default("Not available") }} - {{ sentence.offenceDescription | default("Not available") }}</h4>
                {{ summaryListHtml | safe }}
              {%- endset -%}

              {{ mojTicketPanel({
                classes: "app-ticket-panel--purple-border govuk-!-margin-bottom-5",
                items: [{
                  html: panelHtml
                }]
              }) }}
            {% endfor %}
          {% endif %}
        </div> <!-- govuk-summary-card__content -->
      </div> <!-- govuk-summary-card -->

      <form method="post" novalidate class="govuk-!-margin-top-6">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
        
        {{ govukRadios({
          name: "activeSentenceChoice",
          fieldset: {
            legend: {
              text: "Did this case have an active sentence?",
              isPageHeading: false,
              classes: "govuk-fieldset__legend--m"
            }
          },
          items: [
            {
              value: "YES",
              text: "Yes",
              checked: formResponses.activeSentenceChoice == "YES"
            },
            {
              value: "NO",
              text: "No",
              checked: formResponses.activeSentenceChoice == "NO"
            }
          ],
          errorMessage: errors.activeSentenceChoice
        }) }}

        {{ govukButton({
            text: "Continue",
            preventDoubleClick: true
          }) }}
          <a href="{{ cancelLink }}" role="button" draggable="false" class="govuk-button govuk-button--secondary govuk-!-margin-left-1" data-module="govuk-button">
            Cancel
          </a>
      </form>
    </div>
  </div>
{% endblock %}